---
draft: false
emoji: ğŸ‡
title: Next.jsã§GraphQLã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®codegenã¨urqlã®è¨­å®šæ–¹æ³•
slug: nextjs-graphql-codegen-and-urql
published_at: 2023-10-02 00:12:32
modified_at: 2023-10-02 00:12:32
tags:
  - Next.js
  - GraphQL
preview: null
---

## GraphQL Code Generatorã§TypeScriptã®å‹å®šç¾©ã‚’ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

[GraphQL Code Generator](https://the-guild.dev/graphql/codegen)ã§GraphQLã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰TypeScriptã®å‹å®šç¾©ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¾ã™ã€‚

[Next.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ESLintãƒ»Prettierã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](2023-10-01-Next.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ESLintãƒ»Prettierã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—.md)ã§ä½œæˆã—ãŸç’°å¢ƒã«æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä¸‹è¨˜ã®äºŒã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚Next.jsã§ã‚‚ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’GraphQL codegenã‹ã‚‰ã‚‚ä½¿ç”¨ã™ã‚‹ãŸã‚ã« dotenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚

```sh
pnpm add -E graphql @graphql-typed-document-node/core
```

```sh
pnpm add -D -E @graphql-codegen/cli @graphql-codegen/client-preset dotenv
```

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

.env.development.localã«ä¸‹è¨˜ã®å†…å®¹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```sh
API_ENDPOINT=http://localhost/graphql
API_ACCESS_TOKEN=HOGEHOGE
```

codegen.tsã‚’ä¸‹è¨˜ã®å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚`npx graphql-codegen init` ã§ä½œæˆã—ã¦ã‚‚è‰¯ã„ã§ã™ã€‚

```typescript:codegen.ts
require('dotenv').config({ path: '.env.development.local' })

import { CodegenConfig } from '@graphql-codegen/cli'

const config: CodegenConfig = {
  schema: {
    [`${process.env.API_ENDPOINT}`]: {
      headers: {
        Authorization: `Bearer ${process.env.API_ACCESS_TOKEN}`,
      },
    },
  },
  documents: ['src/**/*.{ts,tsx}'],
  ignoreNoDocuments: true,
  generates: {
    'src/gql/': {
      preset: 'client',
      presetConfig: {
        fragmentMasking: { unmaskFunctionName: 'getFragmentData' },
      },
      plugins: [],
    },
  },
  hooks: { afterAllFileWrite: ['pnpx prettier --write', 'pnpx eslint --fix'] },
}

export default config
```

### package.jsonã®ä¿®æ­£

```json:package.json
"scripts": {
  "codegen": "gql-gen --config codegen.ts"
}
```

## urqlã®è¨­å®šã‚’ã™ã‚‹

GraphQLã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ [urql](https://formidable.com/open-source/urql/) ã‚’ä½¿ã„ã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‘¨ã‚ŠãŒã‚·ãƒ³ãƒ—ãƒ«ãªã®ã§ä½¿ã„ã‚„ã™ã„ã§ã™ã€‚

Next.jsã®Server Componentsã‹ã‚‰ä½¿ã†å ´åˆã®è§£èª¬ã®ã¿è¡Œã„ã¾ã™ã€‚

## urqlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh
pnpm add -E @urql/core @urql/next
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ

ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript:src/urql/client.ts
import { cacheExchange, createClient, fetchExchange } from '@urql/core'
import { registerUrql } from '@urql/next/rsc'

function makeClient() {
  return createClient({
    url: `${process.env.API_ENDPOINT}`,
    exchanges: [cacheExchange, fetchExchange],
    fetchOptions: {
      headers: {
        Authorization: `bearer ${process.env.API_ACCESS_TOKEN}`,
      },
    },
  })
}

export const { getClient } = registerUrql(makeClient)
```

## GraphQLã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹

ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒã§ãã¾ã™ã€‚`src/app/page.tsx` ãªã©ã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

`pnpm codegen` ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ `DocumentDocument` ã®å‹ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```typescript:src/app/page.tsx
import { graphql } from '@/gql'
import { DocumentDocument } from '@/gql/graphql'
import { getClient } from '@/urql/client'

graphql(`
  query document($slug: String) {
    document(slug: $slug) {
      id
    }
  }
`)

export default async function Home() {
  const { data, error } = await getClient().query(DocumentDocument, {
    slug: 'hoge',
  })

  return <>{data.document?.id}</>
}
```

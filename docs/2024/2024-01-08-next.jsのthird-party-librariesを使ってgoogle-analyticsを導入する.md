---
draft: false
emoji: ğŸ˜
title: Next.jsã®Third Party Librariesã‚’ä½¿ã£ã¦Google Analyticsã‚’å°å…¥ã™ã‚‹
slug: introduce-google-analytics-using-third-party-libraries-in-nextjs
published_at: 2024-01-08 22:39:43
modified_at: 2024-07-25 21:26:51
tags:
  - Next.js
preview: null
---

## æ¦‚è¦

Next.jsã®[Third Party Libraries](https://nextjs.org/docs/app/building-your-application/optimizing/third-party-libraries)ã‚’ä½¿ãˆã°ã€ç°¡å˜ã«Google Analyticsã‚’å°å…¥ã§ãã¾ã™ã€‚

## @next/third-partiesã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```sh:Terminal
pnpm add @next/third-parties
```

## ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 

```sh:.env
GA_ID=G-XXXXXXXXXX
```

## app/layout.tsxã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é…ç½®

```tsx:app/layout.tsx
import { GoogleAnalytics } from '@next/third-parties/google'

const isProduction = process.env.NODE_ENV === 'production'
const gaId = process.env.GA_ID!

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
      {isProduction && <GoogleAnalytics gaId={gaId} />}
    </html>
  )
}
```

## `GoogleTagManager` ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ

ç’°å¢ƒå¤‰æ•°ã¨ `app/layout.tsx`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã€‚

```sh:.env
GTM_ID=G-XXXXXXXXXX
```

```tsx:app/layout.tsx
import { GoogleTagManager } from '@next/third-parties/google' // [!code highlight]

const isProduction = process.env.NODE_ENV === 'production'
const gtmId = process.env.GTM_ID! // [!code highlight]

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
      {isProduction && <GoogleTagManager gtmId={gtmId} />} {/* [!code highlight] */}
    </html>
  )
}
```

## Google Analyticsã®æ¸¬å®š ID(gaId)ã®ç¢ºèªæ–¹æ³•

![ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œç®¡ç†ã€](/assets/2024-01-08-next.jsã®third-party-librariesã‚’ä½¿ã£ã¦google-analyticsã‚’å°å…¥ã™ã‚‹.webp)

1. ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œç®¡ç†ã€(ä¸Šè¨˜ç”»åƒ)
2. ãƒ‡ãƒ¼ã‚¿ã®åé›†ã¨ä¿®æ­£
3. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ 
4. å¯¾è±¡ã®ã€Œã‚¦ã‚§ãƒ– ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®è©³ç´°ã€ã‚’é–‹ã
5. æ¸¬å®š IDã®å€¤ `G-XXXXXXXXXX`

## ãŠã¾ã‘ ãã®1: Youtubeã®åŸ‹ã‚è¾¼ã¿

Third Party Librariesã«ã¯Youtubeã®åŸ‹ã‚è¾¼ã¿ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã‚ã‚Šã¾ã™ã€‚`params` ã‚’æ–‡å­—åˆ—ã§é€£çµã—ã¦æ¸¡ã•ãªãã¦ã¯ã„ã‘ãªã„ã®ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§æ¸¡ã—ã¦ä½¿ãˆã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ©ãƒƒãƒ‘ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã‚‹ã¨è‰¯ã„ã§ã™ã€‚

```tsx:youtube.tsx
import { YouTubeEmbed } from '@next/third-parties/google'

export type YoutubeProps = {
  videoid: string
  params?: { [key: string]: string | number | undefined }
  height?: number
  width?: number
  playlabel?: string
  style?: string
}

export default async function Youtube({ params, ...props }: YoutubeProps) {
  const paramsString = params
    ? Object.entries(params)
        .filter(([_, value]) => value !== undefined)
        .map(
          ([key, value]) =>
            `${encodeURIComponent(key)}=${encodeURIComponent(value as string | number)}`
        )
        .join('&')
    : undefined

  return <YouTubeEmbed {...props} params={paramsString} />
}
```

```tsx:ä½¿ã„æ–¹
import { YouTube } from './youtube'

<Youtube videoid="l9IDSs2ASXs" params={ start: 55 } />
```

ã“ã†ã™ã‚‹ã¨ã€55ç§’ã‹ã‚‰é–‹å§‹ã™ã‚‹å‹•ç”»ã‚’åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

### Youtubeã®åŸ‹ã‚è¾¼ã¿ä¾‹

::youtube[https://youtu.be/l9IDSs2ASXs?si=2tLxm3_8Xs9teVD1&t=55]

## ãŠã¾ã‘ ãã®2: ç¾åœ¨ã¯åŒæ„ãƒ¢ãƒ¼ãƒ‰ã®åˆ©ç”¨ã¯ã§ããªã„

Google Analyticsã«ã¯åŒæ„ã«é–¢ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«åŸºã¥ã„ã¦å‹•ä½œã‚’èª¿æ•´ã™ã‚‹[åŒæ„ãƒ¢ãƒ¼ãƒ‰](https://developers.google.com/tag-platform/security/concepts/consent-mode)ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

Third Party Librariesã‚’ä½¿ç”¨ã—ã¦GoogleAnalyticsã‚’å°å…¥ã—ãŸå ´åˆã€ç¾æ™‚ç‚¹ã§ã¯åŒæ„ãƒ¢ãƒ¼ãƒ‰ã®åˆ©ç”¨ã¯ã§ãã¾ã›ã‚“ã€‚

æ¬¡ã®è¨˜äº‹ã®ã‚ˆã†ã«ç‹¬è‡ªã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

::link-card[https://qiita.com/kurab/items/7f1e9d0c2f7d5d67ec07]
